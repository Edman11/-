(()=>{"use strict";function e(e){return new Promise(((t,o)=>{chrome.storage.local.get([e],(n=>chrome.runtime.lastError?o(chrome.runtime.lastError):t(n[e])))}))}function t(e,t){return new Promise(((o,n)=>{chrome.storage.local.set({[e]:t},(()=>chrome.runtime.lastError?n(chrome.runtime.lastError):o()))}))}function o(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefhijklmnopqrstuvwxyz012345678";let o="";for(let n=0;n<e;++n)o+=t.charAt(Math.floor(60*Math.random()));return o}const n={checkIsSubscribed:async()=>{const e=(await n.getUserInfo()).member_time;try{if(e){const t=new Date(e).getTime();return(new Date).getTime()<t}}catch(e){console.log(e)}return!1},postJsonData:(e,t)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),postFormData:(e,t)=>{const o=[];Object.keys(t).forEach((e=>{const n=encodeURIComponent(e),s=encodeURIComponent(t[e]);o.push(n+"="+s)}));const n=o.join("&");return fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:n})},getUserInfo:async()=>{const t=await e("userInfo");return t||null},parseTokenExp:e=>{try{const t=e.split(".");if(3==t.length){const e=decodeURIComponent(atob(t[1]));return 1e3*JSON.parse(e).exp}}catch(t){console.log(t,e)}return null},updateData:async o=>{const n=await e("userInfo");n&&(Object.keys(o).forEach((e=>{n[e]=o[e]})),await t("userInfo",n))},register:async()=>{const e=await n.getUserInfo(),t=await n.postFormData(e.register,{token:e.token,uid:e.uid,channel:e.channel,operateType:e.operateType});if(t.ok){const e=await t.json();if(console.log(e),200==e.code&&"ok"==e.msg){const t=e.data,o=t.member_time;await n.updateData({token:t.token,member_time:o,state:"register"})}}},login:async()=>{const e=await n.getUserInfo(),t=await n.postFormData(e.login,{token:e.token,uid:e.uid,channel:e.channel,operateType:e.operateType});if(t.ok){const e=await t.json();if(console.log(e),200==e.code&&"ok"==e.msg){const t=e.data;if("no user"==t)return!1;const o=t.finishEffective;return await n.updateData({token:t.token,uid:t.openId,member_time:o,state:"logined"}),!0}}return!1},getUserProfile:async()=>{const e=await n.getUserInfo(),t=await n.postFormData(e.userProfile,{operateType:e.operateType,token:e.token,channel:e.channel});if(t.ok){const e=await t.json();if(console.log(e),200==e.code){const t=e.finishEffective;await n.updateData({member_time:t})}}},checkSubscribed:async()=>{let e=await n.getUserInfo();if("unregister"==e.state)return!1;try{let t=e.member_time;if(t){const e=new Date(t).getTime();if((new Date).getTime()<e)return!0}if(await n.getUserProfile(),e=await n.getUserInfo(),t=e.member_time,t){const e=new Date(t).getTime();if((new Date).getTime()<e)return!0}}catch(e){console.log(e)}return!1}},s="https://geckoinfo.cloud",a="unregister",r=o(32),i={baseUrl:s,register:s+"/web/users/register",login:s+"/web/users/login",userProfile:s+"/web/users/user-permission",subscribeUrl:s+"/web/pay/dyex",uid:r,token:r,exp:0,limits:20,state:a,channel:"dyex",operateType:"export"};chrome.runtime.onInstalled.addListener((async()=>{await e("userInfo")||await t("userInfo",i)})),chrome.storage.onChanged.addListener((e=>{for(const[t,o]of Object.entries(e))console.log(`"${t}" changed from "${o.oldValue}" to "${o.newValue}"`)})),chrome.runtime.onMessage.addListener(((e,t,o)=>{const n=e?.messageType;return c[n]&&c[n](e,t,o),!0}));const c={VIDEO_LIST_DETAIL:async(o,s,a)=>{const r=o.data,i=o.secUid,c=await e("infos"),m=c[i];if(m){const e=m.videos.concat(r);m.videos=e;const o=m.videos?.length;if(await l(o))await t("infos",c);else{const e=(await n.getUserInfo()).limits;m.videos=m.videos.slice(0,e),await t("infos",c),chrome.tabs.sendMessage(s.tab.id,{messageType:"GET_DATA_BREAK"},(function(e){console.log("send data")})),chrome.runtime.sendMessage({messageType:"GET_VIDEO_DONE",secUid:i,type:"limited",limits:e},(e=>{console.log(e)}))}}a&&a(!0)},VIDEO_LIST_DONE:async(e,t,o)=>{const n=e.secUid;n&&chrome.runtime.sendMessage({messageType:"GET_VIDEO_DONE",secUid:n},(e=>{console.log(e)})),o&&o(!0)},USER_INFO_DETAIL:async(e,o,n)=>{const s=e.data,a={};a[s.sec_uid]={user:s,videos:[]},t("infos",a),chrome.runtime.sendMessage({messageType:"USER_INFO",data:s},(e=>{console.log(e)})),n&&n(!0)},CHECK_USER_SUB:async(e,t,o)=>{const n=e.data?.count,s=await l(n);o&&o(s)},BUY_NOW:async(e,t,o)=>{let s=await n.getUserInfo();s.state==a&&await n.register(),s=await n.getUserInfo(),chrome.tabs.create({active:!0,url:`${s.subscribeUrl}?token=${s.uid}&channel=${s.channel}`}),o&&o()}};async function l(e){if(!await n.checkSubscribed()){if((await n.getUserInfo()).limits<e)return!1}return!0}})();